import os
import sys
import pathlib
import shutil

def link_context():
    """
    Symlinks the generated GEMINI.md to the user's Obsidian Vault.
    """
    # Get the vault path from Copier answer
    obsidian_vault_path = r"{{ obsidian_vault_path }}"
    project_name = "{{ project_name }}"
    
    # DEBUG: Write to log
    try:
        with open("hook_debug.log", "w") as f:
            f.write(f"Jinja Path: '{obsidian_vault_path}'\n")
            f.write(f"Env Var: '{os.environ.get('OBSIDIAN_VAULT_PATH')}'\n")
    except Exception as e:
        print(f"Failed to write debug log: {e}")

    # Fallback: Check environment variable if not provided
    if not obsidian_vault_path:
        obsidian_vault_path = os.environ.get("OBSIDIAN_VAULT_PATH")
        if obsidian_vault_path:
            print(f"Using OBSIDIAN_VAULT_PATH from environment: {obsidian_vault_path}")

    if not obsidian_vault_path:
        print("Skipping Obsidian link: No vault path provided (and OBSIDIAN_VAULT_PATH not set).")
        # Still perform cleanup even if we skip linking
        cleanup_hooks()
        return

    vault_path = pathlib.Path(obsidian_vault_path)
    if not vault_path.exists():
        print(f"Warning: Obsidian vault path does not exist: {vault_path}")
        cleanup_hooks()
        return

    # Target: The GEMINI.md file in the generated project
    target_file = pathlib.Path("GEMINI.md").resolve()
    
    # Link Name: inside the vault. 
    link_name = vault_path / f"{project_name}_GEMINI.md"
    
    try:
        if link_name.exists():
            print(f"Link already exists: {link_name}")
        else:
            # On Windows, symlinks require admin privileges or Developer Mode.
            os.symlink(target_file, link_name)
            print(f"Successfully linked {target_file} to {link_name}")
        
    except OSError as e:
        # Handle Windows specific error for privileges
        if getattr(e, 'winerror', None) == 1314:
            print("\n" + "!"*60)
            print("WARNING: Could not create symlink due to missing privileges.")
            print("Windows requires 'Developer Mode' enabled or Admin rights to create symlinks.")
            print("To enable Developer Mode: Settings -> Update & Security -> For developers")
            print("!"*60 + "\n")
        else:
            print(f"Failed to create symlink: {e}")
    
    cleanup_hooks()

def cleanup_hooks():
    # Cleanup: Remove the hooks directory
    try:
        hooks_dir = pathlib.Path("hooks")
        if hooks_dir.exists():
            shutil.rmtree(hooks_dir)
            print("Cleaned up hooks directory.")
    except Exception as e:
        print(f"Warning: Failed to cleanup hooks directory: {e}")

if __name__ == "__main__":
    link_context()